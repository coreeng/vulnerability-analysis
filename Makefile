ENVTEST_K8S_VERSION="1.28.0"
ENVTEST="setup-envtest"
LOCALBIN="./bin"

.PHONY: default
default: help

.PHONY: help
help: Makefile
	@echo "Usage: "
	@sed -n 's/^##[ -]/   /p' Makefile
	@echo ""


## make build					Build golang app
.PHONY: build
build: 
	go build -o vulcheck ./cmd/vulnerability-analysis/main.go

## make test					Run unit tests for golang app
.PHONY: test
test: 
	KUBEBUILDER_ASSETS="$(shell $(ENVTEST) use $(ENVTEST_K8S_VERSION) -i --bin-dir $(LOCALBIN) -p path)" go test ./...  

## make run					Runs golang app
.PHONY: run
run: build
	./vulcheck trivy argocd index.docker.io/bitnami/etcd:3.5.12-debian-11-r2

## make setup					setup envtest
.PHONY: setup
setup: 
	@go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest ; \
	mkdir -p bin ; \
	mkdir -p bin/k8s ; \
	setup-envtest use $(ENVTEST_K8S_VERSION) --bin-dir ./bin

