package trivy

import (
	"context"
	"fmt"

	"github.com/coreeng/vulnerability-analysis/pkg/kubernetes"
	"github.com/coreeng/vulnerability-analysis/pkg/report"
	log "github.com/sirupsen/logrus"
	"github.com/spf13/cobra"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"

	"k8s.io/apimachinery/pkg/runtime/schema"
)

func NewTrivyCmd() *cobra.Command {
	trivyCmd := &cobra.Command{
		Use:   "trivy <namespace> <image-name>",
		Short: "Analyse trivy",
		Args:  cobra.ExactArgs(2),
		RunE: func(cmd *cobra.Command, args []string) error {
			cmd.SilenceUsage = true
			return analyseTrivy(args[0], args[1])
		},
	}

	return trivyCmd
}

func analyseTrivy(namespace, image string) error {

	rep, err := listVulnerabilityReports(namespace, image)
	if err != nil {
		return err
	}
	threshold := report.NewReportThreshold()

	return threshold.Validate(rep)
}

func listVulnerabilityReports(namespace, image string) (*report.AnalysisReport, error) {
	log.Infof("Fetching image %s, from namespace %s\n", image, namespace)

	vulnerabilityReportGroup := schema.GroupVersionResource{Group: "aquasecurity.github.io", Version: "v1alpha1", Resource: "vulnerabilityreports"}

	result, err := kubernetes.GetClient().Resource(vulnerabilityReportGroup).Namespace(namespace).List(context.Background(), metav1.ListOptions{})
	if err != nil {
		return nil, report.NewProcessingError(fmt.Sprintf("failed to list VulnerabilityReport: %v", err))
	}

	for _, d := range result.Items {
		repository := kubernetes.GetString(d.Object, "report", "artifact", "repository")
		tag := kubernetes.GetString(d.Object, "report", "artifact", "tag")
		server := kubernetes.GetString(d.Object, "report", "registry", "server")

		if image == fmt.Sprintf("%s/%s:%s", server, repository, tag) {

			return &report.AnalysisReport{
				ImageName:     image,
				CriticalCount: kubernetes.GetInt64(d.Object, "report", "summary", "criticalCount"),
				HighCount:     kubernetes.GetInt64(d.Object, "report", "summary", "highCount"),
				MediumCount:   kubernetes.GetInt64(d.Object, "report", "summary", "mediumCount"),
				LowCount:      kubernetes.GetInt64(d.Object, "report", "summary", "lowCount"),
				UnknownCount:  kubernetes.GetInt64(d.Object, "report", "summary", "unknownCount"),
			}, nil
		}
	}
	return nil, report.NewProcessingError(fmt.Sprintf("Couldn't find vulnerability report for the image '%s' in the namespace '%s'", image, namespace))
}
